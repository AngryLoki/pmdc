; Output: W_PSEUDO_ECHO.M
; Console: W_PSEUDO_ECHO.OUT

#Title W_PSEUDO_ECHO
#Option /v/c

; --- PMDMML 'W' (Pseudo Echo) Command Tests ---

; --- Basic Usage ---
A W8,-1 c2              ; Delay 8 ticks, Vol step -1 (v-level), No continuation(0). Generates c%8^(v-1)c%8^(v-2)c%8...
A Wl16,%-10 c2          ; Delay l16 (6 ticks), Vol step -10 (V-level), No continuation(0). Generates c%6^(V-10)c%6^(V-20)c%6...
A W24,1 c2              ; Delay 24 ticks, Vol step +1 (v-level), No continuation(0). Generates c%24^(v+1)c%24... (Likely hits max vol quickly)

; --- Continuation Flag ---
A W8,-1,0 c2            ; Flag 0: Echo stops at key-off time for original note length. Standard echo decay.
A W8,-1,1 c2            ; Flag 1: Continuation/Tie. Echo *continues* after original note length, volume changes applied at each delay step until volume hits 0. Note remains ON between echoes.
A W8,-1,2 c2            ; Flag 2: Once only/No Tie. Echo occurs once, vol changes, key-off/key-on occurs. Then original note continues at original volume. c%8^(v-1)c%40
A W8,-1,3 c2            ; Flag 3: Once only/Tie. Echo occurs once, vol changes, note stays ON (no re-attack). Then original note continues at *new* volume. c%8 & ^(v-1)c%40

; --- Different Delays ---
A W4,-1 c4              ; Short delay (4 ticks) on a quarter note (24 ticks). Multiple echoes.
A W24,-1 c4             ; Long delay (24 ticks) on a quarter note (24 ticks). Echo happens once right at the end? (Effectively processed as W24,-1,2 c%24?) Compiler might optimize.
A Wl8,-1 c2             ; Delay 1/8th note (12 ticks) on half note (48 ticks).
A C192 Wl16,-1 c4       ; C192: c4=48 ticks. Delay 1/16th (12 ticks). c%12 ^(v-1) c%12 ^(v-2) c%12 ^(v-3) c%12
A C96                   ; Reset C

; --- Interaction with Note Length ---
A W12,-1 c8             ; Delay 12 ticks, Note length c8 (12 ticks). Echo triggers exactly once at the end? (Similar to W24, c4)
A W16,-1 c8             ; Delay 16 ticks > Note length c8 (12 ticks). W effect should NOT apply. Played as normal c8.
A W8,-1,1 c8            ; Flag 1: Continue after note ends. c%8^(v-1)c%8^(v-2)c%8... sounds beyond original 12 ticks.

; --- Interaction with Volume ---
A v12 W8,-1 c2          ; Set volume before W. Echo steps down from v12.
A W8,-1 v12 c2          ; Set volume after W. Echo steps down from v12 (W only defines parameters).
A v8 W8,1 c2            ; Step volume up from v8.
A v15 W8,%-10 c2         ; Step V-level down from v15 (V=125). -> V115 -> V105...
A V64 W8,%10 c2         ; Step V-level up from V64. -> V74 -> V84...

; --- Interaction with Q/q (Gate Time) ---
; How W interacts with early key-off is implementation-dependent.
; Does the W processing use the *full* note length or the *gated* length?
; Assuming W uses the full length for its iterations, but Q/q forces an earlier *final* key-off.
A Q4 W8,-1 c2           ; c2=48. Q4 target=24. W generates echoes based on 48 ticks, but sound stops at 24 ticks.
A q10 W8,-1 c2          ; c2=48. W generates echoes. q10 forces key-off 10 ticks before the *end* of each generated segment? Or 10 ticks before the final effective end? Needs testing. Likely applies to the *final* note-off.

; --- Interaction with Tie (&) ---
; Manual ยง4-10 Note 1: "During W, S command execution, only the sound of the last volume/pitch after processing changes."
; "notes immediately after the & command are not affected by the W, S commands."
A W8,-1 c8&c8           ; W applies to first c8. Echoes generate based on its 12 ticks. The second c8 is tied normally *after* W processing finishes for the first c8.
A W8,-1,1 c8&c8         ; Flag 1: Echo continues. How does tie interact? Does the tied note start at the *last* echo volume? Does the echo stop? Likely, the echo continues, and the tie just extends the duration from the *original* volume level, ignoring W on the 2nd note.

; --- Turning W Off ---
A W8,-1 c4 d4 W0 e4 f4  ; W active for c,d. W inactive for e,f.

; --- Potential Edge Cases ---
A W1,-1 c4              ; Very fast delay.
A W8,-8 c4              ; Large volume step (v-level).
A W8,%-100 c4           ; Large volume step (V-level).
A W8,0 c4               ; Zero volume step (should just repeat note segments if flag=1?).

; --- Use on different sound sources (Syntax is valid, effect depends on driver/LSI) ---
G W8,-1 c2              ; SSG
J W8,-1 c2              ; PCM (if supported by specific PMD version/platform)

